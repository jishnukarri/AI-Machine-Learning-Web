<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ocean Cleanup AI</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    /* Optional: Add custom styles here */
  </style>
</head>

<body class="bg-blue-100 font-sans text-gray-800 min-h-screen flex flex-col justify-center items-center">
  <!-- Loading Screen -->
  <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
    <p class="text-2xl font-bold mb-4" id="loading-status">Loading...</p>
    <div class="w-64 h-4 bg-gray-200 rounded-full overflow-hidden">
      <div id="loading-progress" class="h-full bg-teal-500 w-0"></div>
    </div>
    <p class="text-sm mt-2 text-gray-600" id="loading-details">Initializing...</p>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="hidden container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-center mb-6 text-teal-700">Ocean Cleanup AI</h1>
    <p class="text-lg text-center mb-10 text-gray-700">
      Classify images of ocean debris using AI-powered technology.
    </p>

    <!-- Slideshow Section -->
    <div class="slideshow bg-white p-6 rounded-lg shadow-lg">
      <div class="slideshow-image relative h-96 flex justify-center items-center overflow-hidden rounded-lg">
        <img id="current-image" src="" alt="Current Image" class="max-w-full max-h-full object-contain">
      </div>
      <div class="slideshow-stats mt-6">
        <div class="flex justify-between items-center mb-4">
          <span class="text-gray-700">Garbage: <span id="garbage-percentage" class="font-bold text-red-600">0%</span></span>
          <div class="w-2/3 bg-gray-200 h-4 rounded-full overflow-hidden">
            <div id="garbage-progress" class="h-full bg-red-500 w-0"></div>
          </div>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-700">Marine Life: <span id="marine-life-percentage" class="font-bold text-green-600">0%</span></span>
          <div class="w-2/3 bg-gray-200 h-4 rounded-full overflow-hidden">
            <div id="marine-life-progress" class="h-full bg-green-500 w-0"></div>
          </div>
        </div>
      </div>
      <div class="slideshow-controls mt-6 flex justify-center space-x-4">
        <button id="prev-btn" class="px-4 py-2 bg-teal-500 text-white rounded hover:bg-teal-600">❮ Previous</button>
        <button id="next-btn" class="px-4 py-2 bg-teal-500 text-white rounded hover:bg-teal-600">Next ❯</button>
      </div>
    </div>
  </div>

  <script>
    let model;
    let images = [];
    let currentIndex = 0;

    // Load the TensorFlow.js model
    async function loadModel() {
      updateLoadingScreen('Loading TensorFlow.js model...', 'Fetching and initializing the AI model...');
      try {
        model = await tf.loadLayersModel('model-new/model.json');
        console.log('Model loaded successfully!');
      } catch (error) {
        console.error('Error loading model:', error);
      }
    }

    // Fetch random garbage and marine life images using Google Custom Search API
    async function fetchRandomImages() {
      const apiKey = '{{ GOOGLE_API_KEY }}'; // Placeholder for GitHub Secret
      const cx = '{{ CUSTOM_SEARCH_ENGINE_ID }}'; // Placeholder for GitHub Secret
      const keywords = ['garbage in ocean', 'marine life underwater'];
      const numImagesPerCategory = 6; // Fetch 6 images per category

      updateLoadingScreen('Fetching images...', 'Searching for relevant images using Google Custom Search API...');

      for (const keyword of keywords) {
        try {
          const response = await fetch(
            `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(keyword)}&searchType=image&num=${numImagesPerCategory}`
          );
          const data = await response.json();
          if (data.items) {
            const imageLinks = data.items.map(item => item.link.replace('http://', 'https://'));
            images.push(...imageLinks);
            updateLoadingDetails(`Fetched ${imageLinks.length} images for "${keyword}"`);
            console.log(`Fetched images for "${keyword}":`, imageLinks);
          }
        } catch (error) {
          console.error('Error fetching images:', error);
          updateLoadingDetails(`Failed to fetch images for "${keyword}"`);
        }
      }

      // Randomize the order of images
      images = [...new Set(images)].sort(() => Math.random() - 0.5);

      // Filter out invalid or problematic image URLs
      images = images.filter(src => /\.(jpg|jpeg|png|webp)$/i.test(src));
    }

    // Preload all images to ensure smooth performance
    async function preloadImages() {
      updateLoadingScreen('Preloading images...', 'Loading images into memory for faster performance...');
      const progressElement = document.getElementById('loading-progress');
      const totalImages = images.length;
      let loadedImages = 0;

      const promises = images.map(src => {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.crossOrigin = 'anonymous'; // Handle CORS issues
          img.src = src; // Use the `src` parameter here
          img.onload = () => {
            loadedImages++;
            progressElement.style.width = `${(loadedImages / totalImages) * 100}%`;
            updateLoadingDetails(`Loaded ${loadedImages}/${totalImages} images`);
            resolve();
          };
          img.onerror = () => {
            console.error(`Failed to load image: ${src}`);
            resolve(); // Continue even if some images fail to load
          };
        });
      });

      try {
        await Promise.all(promises);
        console.log('All images preloaded successfully.');
      } catch (error) {
        console.error('Error preloading images:', error);
      }
    }

    // Display the current image
    function showImage(index) {
      if (index < 0 || index >= images.length) return;

      const img = document.getElementById('current-image');
      img.src = images[index];
      predict(images[index]);
    }

    // Predict the class of the selected image
    async function predict(imageSrc) {
      const img = new Image();
      img.crossOrigin = 'anonymous'; // Handle CORS issues
      img.src = imageSrc;
      img.onload = async () => {
        try {
          if (!model) {
            console.error('Model is not loaded yet.');
            return;
          }

          // Preprocess the image
          const tensor = tf.browser.fromPixels(img)
              .resizeNearestNeighbor([224, 224]) // Resize to match model input size
              .toFloat()
              .div(255.0) // Normalize pixel values
              .expandDims(); // Add batch dimension

          // Make predictions
          const predictions = await model.predict(tensor).data();
          const garbagePercent = Math.round(predictions[0] * 100);
          const marineLifePercent = 100 - garbagePercent;

          // Update statistics dynamically
          updateStats(garbagePercent, marineLifePercent);

          console.log('Predictions:', predictions);
        } catch (error) {
          console.error('Error during prediction:', error);
        }
      };
      img.onerror = () => {
        console.error(`Failed to load image for prediction: ${imageSrc}`);
      };
    }

    // Update statistics and progress bars
    function updateStats(garbagePercent, marineLifePercent) {
      document.getElementById('garbage-percentage').innerText = `${garbagePercent}%`;
      document.getElementById('marine-life-percentage').innerText = `${marineLifePercent}%`;

      // Animate progress bars
      document.getElementById('garbage-progress').style.width = `${garbagePercent}%`;
      document.getElementById('marine-life-progress').style.width = `${marineLifePercent}%`;
    }

    // Attach event listeners for navigation
    document.getElementById('prev-btn').addEventListener('click', () => {
      currentIndex = Math.max(currentIndex - 1, 0);
      showImage(currentIndex);
    });

    document.getElementById('next-btn').addEventListener('click', () => {
      currentIndex = Math.min(currentIndex + 1, images.length - 1);
      showImage(currentIndex);
    });

    // Update loading screen messages
    function updateLoadingScreen(status, details) {
      document.getElementById('loading-status').innerText = status;
      document.getElementById('loading-details').innerText = details;
    }

    function updateLoadingDetails(details) {
      document.getElementById('loading-details').innerText = details;
    }

    // Load everything when the page loads
    window.onload = async () => {
      await loadModel();
      await fetchRandomImages();
      await preloadImages();

      // Hide loading screen and show main content
      document.getElementById('loading-screen').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');

      showImage(currentIndex);
    };
  </script>
</body>

</html>